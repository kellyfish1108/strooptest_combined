<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Stroop é¡è‰²éŠæˆ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Antique Olive Compact", system-ui, -apple-system,
        BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #f5f6fb;
    }

    .page {
      display: none;
      width: 100vw;
      height: 100vh;
      padding: 24px;
    }

    .page.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .btn {
      padding: 12px 32px;
      margin-top: 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      background: #3b82f6;
      color: #fff;
      box-shadow: 0 10px 18px rgba(59,130,246,0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(59,130,246,0.3);
      background: #2563eb;
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 14px rgba(59,130,246,0.25);
    }

    /* ===== Page 1ï¼šèªªæ˜é  ===== */

    #page-1-card {
      width: 100%;
      max-width: 980px;
      background: #ffffff;
      border-radius: 28px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.12);
      padding: 32px 40px 30px;
    }

    #page-1-card h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 2rem;
      color: #111827;
    }

    #page-1-subtitle {
      text-align: center;
      margin-bottom: 16px;
      color: #6b7280;
      font-size: 0.95rem;
    }

    .page1-main {
      display: flex;
      gap: 28px;
      align-items: flex-start;
      margin-top: 8px;
    }

    .page1-left {
      flex: 3;
    }

    .page1-right {
      flex: 2;
      display: flex;
      justify-content: center;
    }

    ol {
      margin-left: 1.2rem;
    }

    li {
      margin-bottom: 8px;
      line-height: 1.7;
      color: #374151;
      font-size: 0.98rem;
    }

    .example-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      font-size: 0.95rem;
      color: #374151;
    }

    .page-1-footer {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    /* å³é‚Šç¤ºæ„åœ–ï¼šä¸Šé¢ç´…è‰²ã€Œé»ƒã€ï¼Œä¸‹é¢å››å€‹å½©è‰²åœ“åœˆ */

    .preview-box {
      width: 260px;
      max-width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 26px;
      background: #ffffff;
      box-shadow: 0 18px 30px rgba(15,23,42,0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 28px 18px 22px;
    }

    .preview-char {
      font-size: 90px;
      font-weight: 900;
      color: #C00000;
      user-select: none;
      margin-top: 4px;
    }

    .preview-circles {
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 4px;
      margin-bottom: 2px;
    }

    .preview-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 22px;
      user-select: none;
    }

    .preview-circle.red   { background: #C00000; }
    .preview-circle.yellow{ background: #FFD501; }
    .preview-circle.blue  { background: #0070C0; }
    .preview-circle.green { background: #00B050; }
    .preview-circle span { color:#ffffff; }

    /* ===== Page 2ï¼šå—æ¸¬è€…è³‡è¨Š ===== */

    #page-2-card {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 16px 36px rgba(15,23,42,0.1);
      padding: 32px 36px 28px;
    }

    #page-2-card h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.7rem;
      color: #111827;
    }

    .form-group {
      margin: 10px 0;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 6px;
      color: #374151;
      font-size: 0.95rem;
    }

    .form-group input {
      padding: 9px 10px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #d1d5db;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
    }

    /* ===== Page 3ï¼šç·´ç¿’èªªæ˜ ===== */

    #practice-intro-card {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 16px 36px rgba(15,23,42,0.12);
      padding: 32px 36px 28px;
      text-align: center;
    }

    #practice-intro-card p {
      color: #4b5563;
      margin-top: 8px;
      line-height: 1.6;
    }

    /* ===== Page 4ï¼šæ¸¬é©—ç•«é¢ï¼ˆç·´ç¿’ & æ­£å¼ï¼‰ ===== */

    #test-page {
      padding: 0;
      background: #ffffff;
    }

    #test-layout {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #mode-label {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1rem;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,0.06);
      color: #374151;
      z-index: 20;
    }

    #word-container {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
      padding-top: 80px;
    }

    #stroop-word {
      font-size: 20vmin;
      font-weight: 900;
      user-select: none;
    }

    #options-row {
      width: 100%;
      padding-bottom: 60px;
      display: flex;
      justify-content: space-evenly;
      align-items: flex-end;
    }

    .color-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      outline: none;
      padding: 0;
      background: #555555;
      color: #ffffff;
      font-size: 40px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background 0.15s, color 0.15s, transform 0.1s;
    }

    .color-button:active {
      transform: scale(0.97);
    }

    /* ç·´ç¿’ç­”æ¡ˆæç¤º */

    #practice-feedback {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 24px;
      background: transparent;
      z-index: 40;
      cursor: pointer;
    }

    #practice-feedback-text {
      padding: 6px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      color: #4b5563;
      font-size: 0.95rem;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    /* å€’æ•¸ç•«é¢ */

    #countdown-screen {
      position: fixed;
      inset: 0;
      background: #ffffff;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    #countdown-number {
      font-size: 13vmin;
      color: #4b5563;
      font-weight: 500;
      user-select: none;
    }

    /* ===== æ¨¡å¼é¸æ“‡é  ===== */

    #mode-choose-card {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 16px 36px rgba(15,23,42,0.12);
      padding: 32px 36px 28px;
      text-align: center;
    }

    #mode-choose-card h2 {
      font-size: 1.6rem;
      margin-bottom: 8px;
      color: #111827;
    }

    #mode-choose-card p {
      color: #4b5563;
      margin-bottom: 18px;
      line-height: 1.6;
    }

    #mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    #mode-buttons .btn {
      width: 100%;
      max-width: 260px;
    }

    /* ===== çµæœæ‘˜è¦é  ===== */

    #page-4-card {
      width: 100%;
      max-width: 880px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 16px 36px rgba(15,23,42,0.12);
      padding: 30px 32px 24px;
    }

    .result-header-title {
      text-align: center;
      font-size: 1.7rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 10px;
    }

    .result-summary-box {
      background: #eef2ff;
      border-radius: 18px;
      padding: 14px 18px;
      margin: 0 auto 18px;
      max-width: 520px;
      color: #374151;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .result-summary-line {
      margin: 2px 0;
      text-align: center;
    }

    #results-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .choice-symbol {
      font-size: 20px;
      font-weight: 900;
    }

    .result-ok-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background-color: #22c55e;
    }

    .result-bad {
      color: #ef4444;
      font-weight: 600;
    }

    /* è©³ç´°ç­”é¡Œè¨˜éŒ„é  */

    #detail-card {
      width: 100%;
      max-width: 880px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 16px 36px rgba(15,23,42,0.12);
      padding: 26px 26px 20px;
    }

    #detail-card h2 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.5rem;
      color: #111827;
    }

    .results-table-wrapper {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 6px;
      max-height: 420px;
      overflow: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
      background: #ffffff;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      font-size: 0.85rem;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:last-child td {
      border-bottom: none;
    }

    @media (max-width: 900px) {
      .page1-main {
        flex-direction: column;
      }
      .page1-right {
        order: -1;
        margin-bottom: 12px;
      }
    }

    @media (max-width: 640px) {
      .page {
        padding: 18px;
      }

      #page-1-card,
      #page-2-card,
      #practice-intro-card,
      #mode-choose-card,
      #page-4-card,
      #detail-card {
        padding: 24px 18px 18px;
      }

      .page1-main {
        flex-direction: column;
        gap: 18px;
        align-items: stretch;
      }
      .page1-left,
      .page1-right {
        flex: none;
        width: 100%;
      }

      #page-1-card h1 {
        font-size: 1.5rem;
      }

      li {
        font-size: 0.9rem;
      }

      #stroop-word {
        font-size: 18vmin;
      }

      .color-button {
        width: 80px;
        height: 80px;
        font-size: 32px;
      }

      .preview-circle {
        width: 46px;
        height: 46px;
      }
    }
  </style>
</head>
<body>

  <section id="page-1" class="page active">
    <div id="page-1-card">
      <h1>Stroop é¡è‰²éŠæˆ²</h1>
      <div id="page-1-subtitle">
        æ­¡è¿ä¾†ç©é¡è‰²åæ‡‰éŠæˆ²ï¼Œè«‹å…ˆçœ‹å®Œä¸‹é¢èªªæ˜ã€‚
      </div>

      <div class="page1-main">
        <div class="page1-left">
          <ol>
            <li>æ­£å¼éŠæˆ²å¯ä»¥é¸æ“‡ <strong>20 é¡Œç‰ˆ</strong> æˆ– <strong>45 ç§’ç‰ˆ</strong>ï¼ˆé¡è‰²ç‰ˆæˆ–æ–‡å­—ç‰ˆï¼‰</li>
            <li>è¢å¹•ä¸­é–“æœƒå‡ºç¾ä¸€å€‹ã€Œé¡è‰²å­—ã€</li>
            <li><strong>ä¸è¦å¿µå­—çš„æ„æ€</strong>ï¼Œåªè¦çœ‹å­— çš„ã€Œé¡è‰²ã€ã€‚</li>
            <li>è¢å¹•ä¸‹æ–¹æœ‰å››å€‹åœ“åœˆï¼šç´…ã€é»ƒã€è—ã€ç¶ ã€‚è«‹é»é¸è·Ÿé¡è‰²ä¸€æ¨£çš„åœ“åœˆã€‚</li>
            <li>æ­£å¼æ¸¬é©—å‰ï¼Œæœƒå…ˆæœ‰ç·´ç¿’é¡Œï¼Œæ¯é¡Œå®Œæˆéƒ½æœƒå‘Šè¨´ä½ æ­£ç¢ºç­”æ¡ˆã€‚</li>
          </ol>
          <div class="example-box">
            ç¯„ä¾‹ï¼šå¦‚æœä½ çœ‹åˆ°çš„æ˜¯
            <span style="color:#C00000;font-weight:700;">é»ƒ</span>ï¼Œä»£è¡¨å­—çš„é¡è‰²æ˜¯<strong>ç´…è‰²</strong>ï¼Œ
            è¦å»æŒ‰ç´…è‰²çš„åœ“åœˆã€‚
          </div>
        </div>

        <div class="page1-right">
          <div class="preview-box">
            <div class="preview-char">é»ƒ</div>
            <div class="preview-circles">
              <div class="preview-circle red"><span>ç´…</span></div>
              <div class="preview-circle yellow"><span>é»ƒ</span></div>
              <div class="preview-circle blue"><span>è—</span></div>
              <div class="preview-circle green"><span>ç¶ </span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="page-1-footer">
        <button class="btn" id="go-to-info">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
  </section>

  <section id="page-2" class="page">
    <div id="page-2-card">
      <h1>åŸºæœ¬è³‡æ–™</h1>
      <div class="form-group">
        <label for="name">å§“å</label>
        <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å" />
      </div>
      <div class="form-group">
        <label for="birthday">ç”Ÿæ—¥</label>
        <input type="date" id="birthday" />
      </div>
      <div style="display:flex;justify-content:center;margin-top:12px;">
        <button class="btn" id="go-to-practice-intro">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
  </section>

  <section id="practice-intro-page" class="page">
    <div id="practice-intro-card">
      <h2>å…ˆä¾†åšå¹¾é¡Œç·´ç¿’</h2>
      <p>
        ç­‰ä¸€ä¸‹æœƒæœ‰6é¡Œç·´ç¿’é¡Œï¼Œè®“ä½ ç†Ÿæ‚‰ç©æ³•ã€‚<br />
        æ¯ä¸€é¡Œä½œç­”å¾Œï¼Œæœƒå‘Šè¨´ä½ æ­£ç¢ºç­”æ¡ˆï¼Œé»ä¸€ä¸‹è¢å¹•æœƒç¹¼çºŒä¸‹ä¸€é¡Œã€‚<br />
      </p>
      <button class="btn" id="start-practice">é–‹å§‹ç·´ç¿’</button>
    </div>
  </section>

  <section id="test-page" class="page">
    <div id="test-layout">
      <div id="mode-label"></div>

      <div id="word-container">
        <div id="stroop-word">é»ƒ</div>
      </div>

      <div id="options-row">
        <button class="color-button" data-color-key="red"></button>
        <button class="color-button" data-color-key="yellow"></button>
        <button class="color-button" data-color-key="blue"></button>
        <button class="color-button" data-color-key="green"></button>
      </div>
    </div>
  </section>

  <div id="practice-feedback">
    <div id="practice-feedback-text">é€™æ˜¯æ­£ç¢ºçš„é¡è‰²ï¼Œè«‹é»ä¸€ä¸‹ç¹¼çºŒä¸‹ä¸€é¡Œç·´ç¿’ã€‚</div>
  </div>

  <div id="countdown-screen">
    <div id="countdown-number">3</div>
  </div>

  <section id="mode-choose-page" class="page">
    <div id="mode-choose-card">
      <h2>é¸æ“‡æ­£å¼æ¸¬é©—æ–¹å¼</h2>
      <p>ç·´ç¿’çµæŸå›‰ï¼æ¥ä¸‹ä¾†è«‹é¸æ“‡è¦ç©çš„ç‰ˆæœ¬ã€‚</p>
      <div id="mode-buttons">
        <button class="btn" id="btn-mode-20">20 é¡Œé¡è‰²ç‰ˆ</button>
        <button class="btn" id="btn-mode-45-color">45 ç§’é¡è‰²ç‰ˆ</button>
        <button class="btn" id="btn-mode-45-text">45 ç§’æ–‡å­—ç‰ˆ</button>
      </div>
    </div>
  </section>

  <section id="page-4" class="page">
    <div id="page-4-card">
      <div class="result-header-title" id="result-title">æ¸¬é©—å®Œæˆ</div>
      <div class="result-summary-box" id="results-summary"></div>
      <div id="results-buttons">
        <button class="btn" id="btn-restart">å†ç©ä¸€æ¬¡</button>
        <button class="btn" id="btn-show-detail">è©³ç´°ç­”é¡Œè¨˜éŒ„</button>
        <button class="btn" id="btn-export">åŒ¯å‡ºçµæœ (CSV)</button> </div>
    </div>
  </section>

  <section id="detail-page" class="page">
    <div id="detail-card">
      <h2 id="detail-title">è©³ç´°ç­”é¡Œè¨˜éŒ„</h2>
      <div class="results-table-wrapper">
        <table id="results-table">
          <thead>
            <tr>
              <th>é¡Œè™Ÿ</th>
              <th>é¡Œç›®(å­—/è‰²)</th>
              <th>æ­£ç¢ºç­”æ¡ˆ</th>
              <th>æ‚¨çš„é¸æ“‡</th>
              <th>çµæœ</th>
              <th>åæ‡‰æ™‚é–“(ms)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="display:flex;justify-content:center;margin-top:18px;">
        <button class="btn" id="btn-detail-back">ä¸Šä¸€é </button>
      </div>
    </div>
  </section>

  <script>
    window.addEventListener('load', () => {
      const COLOR_CONFIG = [
        { key: "red",    char: "ç´…", label: "ç´…è‰²", hex: "#C00000" },
        { key: "yellow", char: "é»ƒ", label: "é»ƒè‰²", hex: "#FFD501" },
        { key: "blue",   char: "è—", label: "è—è‰²", hex: "#0070C0" },
        { key: "green",  char: "ç¶ ", label: "ç¶ è‰²", hex: "#00B050" },
      ];
      const COLOR_BY_KEY = COLOR_CONFIG.reduce((m,c)=>{m[c.key]=c;return m;}, {});

      const MODE_NONE        = "none";
      const MODE_PRACTICE1   = "practice1";
      const MODE_PRACTICE2   = "practice2";
      const MODE_TEST        = "test";

      const TEST_MODE_20         = "test20";
      const TEST_MODE_45_COLOR   = "test45_color";
      const TEST_MODE_45_TEXT    = "test45_text";

      const PRACTICE_TYPE1_TRIALS = 4;
      const PRACTICE_TYPE2_TRIALS = 1;
      const TEST_DURATION_MS = 45000;
      const TEST_20_QUESTION_COUNT = 20;

      const page1 = document.getElementById("page-1");
      const page2 = document.getElementById("page-2");
      const practiceIntroPage = document.getElementById("practice-intro-page");
      const testPage = document.getElementById("test-page");
      const modeChoosePage = document.getElementById("mode-choose-page");
      const page4 = document.getElementById("page-4");
      const detailPage = document.getElementById("detail-page");

      const pages = [page1, page2, practiceIntroPage, testPage, modeChoosePage, page4, detailPage];

      const goToInfoBtn = document.getElementById("go-to-info");
      const goToPracticeIntroBtn = document.getElementById("go-to-practice-intro");
      const startPracticeBtn = document.getElementById("start-practice");

      const btnMode20 = document.getElementById("btn-mode-20");
      const btnMode45Color = document.getElementById("btn-mode-45-color");
      const btnMode45Text = document.getElementById("btn-mode-45-text");

      const restartBtn = document.getElementById("btn-restart");
      const showDetailBtn = document.getElementById("btn-show-detail");
      const exportBtn = document.getElementById("btn-export"); // ğŸ¯ å–å¾—æ–°çš„åŒ¯å‡ºæŒ‰éˆ•
      const detailBackBtn = document.getElementById("btn-detail-back");

      const stroopWordEl = document.getElementById("stroop-word");
      const colorButtons = Array.from(document.querySelectorAll(".color-button"));
      const modeLabelEl = document.getElementById("mode-label");

      const practiceFeedback = document.getElementById("practice-feedback");
      const countdownScreen = document.getElementById("countdown-screen");
      const countdownNumber = document.getElementById("countdown-number");

      const resultsSummary = document.getElementById("results-summary");
      const resultTitleEl = document.getElementById("result-title");
      const detailTitleEl = document.getElementById("detail-title");
      const resultsTableBody = document.querySelector("#results-table tbody");

      // ã€ğŸ¯ æ–°å¢ï¼šè¨ˆç®—å¹´é½¡çš„è¼”åŠ©å‡½å¼ (æ ¼å¼: ??æ­²??å€‹æœˆ)ã€‘
      function calculateAge(birthdayString) {
        if (!birthdayString) return "N/A";
        const birthday = new Date(birthdayString);
        const today = new Date();
        
        let years = today.getFullYear() - birthday.getFullYear();
        let months = today.getMonth() - birthday.getMonth();
        
        // å¦‚æœä»Šå¤©çš„æœˆä»½å°æ–¼ç”Ÿæ—¥æœˆä»½ï¼Œæˆ–æœˆä»½ç›¸åŒä½†å¤©æ•¸å°æ–¼ç”Ÿæ—¥å¤©æ•¸ï¼Œå‰‡å‘å¹´ä»½å€Ÿä½
        if (months < 0 || (months === 0 && today.getDate() < birthday.getDate())) {
          years--;
          months += 12;
        }

        // å¦‚æœè¨ˆç®—å¾Œçš„æœˆä»½ä»å°æ–¼ 0 (å¯èƒ½å› ç‚ºä¸Šé¢years--å¾Œmonthsä»è² æ•¸)ï¼Œå‰‡èª¿æ•´æœˆä»½
        if (months < 0) months += 12;
        
        if (years < 0) return "N/A"; // å¦‚æœç”Ÿæ—¥åœ¨æœªä¾†ï¼Œå‰‡é¡¯ç¤º N/A

        return `${years}æ­²${months}å€‹æœˆ`;
      }
      
      // ã€ğŸ¯ æ–°å¢ï¼šè½‰æ› records ç‚º CSV æ ¼å¼ã€‘
      function recordsToCsv(records, name, birthday, testMode) {
        // æ¨™é ­
        const headers = ["å§“å", "ç”Ÿæ—¥", "æ¸¬é©—æ¨¡å¼", "é¡Œè™Ÿ", "å­—å…ƒ", "å¢¨æ°´é¡è‰²", "æ­£ç¢ºç­”æ¡ˆ", "æ‚¨çš„é¸æ“‡", "æ˜¯å¦æ­£ç¢º", "åæ‡‰æ™‚é–“(ms)"];
        
        let csv = headers.join(",") + "\n";
        
        records.forEach(r => {
            const row = [
                name,
                birthday,
                testMode,
                r.trialNumber,
                r.wordChar,
                COLOR_BY_KEY[r.inkColorKey].label,
                r.correctAnswer, // æ¨™ç±¤
                r.chosenAnswer,  // æ¨™ç±¤
                r.isCorrect ? "æ­£ç¢º" : "éŒ¯èª¤",
                r.reactionTimeMs
            ];
            // ç”¨é›™å¼•è™ŸåŒ…ä½æ‰€æœ‰è³‡æ–™ï¼Œç¢ºä¿ä¸­æ–‡å’Œé€—è™Ÿèƒ½æ­£ç¢ºè™•ç†
            csv += row.map(d => `"${d}"`).join(",") + "\n";
        });
        return csv;
      }
      
      // ã€ğŸ¯ æ–°å¢ï¼šä¸‹è¼‰ CSV æª”æ¡ˆã€‘
      function downloadCsv(csvString, fileName) {
          // ä½¿ç”¨ \ufeff æ·»åŠ  BOMï¼Œç¢ºä¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
          const blob = new Blob(['\ufeff', csvString], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          if (link.download !== undefined) { 
              const url = URL.createObjectURL(blob);
              link.setAttribute("href", url);
              link.setAttribute("download", fileName);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
      }

      let currentMode = MODE_NONE;
      let currentTestMode = null;

      let practiceType1Index = 0;
      let practiceType2Index = 0;
      let practiceType1Order = [];

      let currentInkColorKey = null;
      let currentWordChar = null;

      let previousTestWordChar = null;
      let lastCorrectKeys = [];   // ç”¨ä¾†é¿å…æ­£ç¢ºç­”æ¡ˆé€£çºŒä¸‰é¡Œç›¸åŒï¼ˆåªè¨˜éŒ„æœ€è¿‘å…©é¡Œï¼‰

      let testStartTime = null;
      let trialStartTime = null;
      let records = [];
      let questionIndex = 0;      // æ­£å¼æ¸¬é©—å·²åšé¡Œæ•¸ï¼ˆ20 é¡Œç‰ˆç”¨ï¼‰

      function showPage(pageElement) {
        pages.forEach(p => p.classList.remove("active"));
        if (pageElement) pageElement.classList.add("active");
      }

      function shuffleArray(array) {
        const arr = array.slice();
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function pickRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      function setModeLabel(text) {
        if (modeLabelEl) modeLabelEl.textContent = text || "";
      }

      /* --- åº•ä¸‹å››å€‹åœ“åœˆæ¨£å¼ --- */

      function setButtonsForColorCircles() {
        // å›ºå®šé †åºï¼šç´…ã€é»ƒã€è—ã€ç¶ 
        const order = ["red","yellow","blue","green"];
        colorButtons.forEach((btn, idx) => {
          const key = order[idx];
          const cfg = COLOR_BY_KEY[key];
          btn.dataset.colorKey = key;
          btn.textContent = "";
          btn.style.backgroundColor = cfg.hex;
          btn.style.color = "#ffffff";
        });
      }

      function setButtonsForTextButtons() {
        const order = ["red","yellow","blue","green"];
        colorButtons.forEach((btn, idx) => {
          const key = order[idx];
          const cfg = COLOR_BY_KEY[key];
          btn.dataset.colorKey = key;
          btn.textContent = cfg.char;
          btn.style.backgroundColor = "#555555";
          btn.style.color = "#ffffff";
        });
      }

      /* --- ç·´ç¿’ (ä¿æŒä¸è®Š) --- */

      function startPracticeSequence() {
        currentMode = MODE_PRACTICE1;
        currentTestMode = null;
        practiceType1Index = 0;
        practiceType2Index = 0;
        practiceType1Order = shuffleArray(COLOR_CONFIG.map(c => c.key));
        setModeLabel("ç·´ç¿’é¡Œ");
        setButtonsForColorCircles();
        showPage(testPage);
        setupNextPracticeTrial();
      }

      function setupNextPracticeTrial() {
        showPage(testPage);
        setModeLabel("ç·´ç¿’é¡Œ");

        if (currentMode === MODE_PRACTICE1) {
          if (practiceType1Index >= PRACTICE_TYPE1_TRIALS) {
            currentMode = MODE_PRACTICE2;
            setupNextPracticeTrial();
            return;
          }
          const colorKey = practiceType1Order[practiceType1Index];
          const colorCfg = COLOR_BY_KEY[colorKey];

          currentInkColorKey = colorKey;
          currentWordChar = "X";
          stroopWordEl.textContent = "X";
          stroopWordEl.style.color = colorCfg.hex;
        } else if (currentMode === MODE_PRACTICE2) {
          if (practiceType2Index >= PRACTICE_TYPE2_TRIALS) {
            currentMode = MODE_NONE;
            setModeLabel("");
            // ç·´ç¿’çµæŸï¼Œé€²å…¥æ¨¡å¼é¸æ“‡é 
            showPage(modeChoosePage);
            return;
          }
          // å›ºå®šï¼šç´…è‰²çš„ã€Œé»ƒã€
          currentInkColorKey = "red";
          currentWordChar = "é»ƒ";
          stroopWordEl.textContent = currentWordChar;
          stroopWordEl.style.color = COLOR_BY_KEY["red"].hex;
        }
      }

      function showPracticeFeedback() {
        // æ­£ç¢ºé‚£æ ¼ä¿æŒåŸæœ¬é¡è‰²ï¼Œå…¶ä»–ä¸‰æ ¼è®Šæˆç™½è‰²
        colorButtons.forEach(btn => {
          const key = btn.dataset.colorKey;
          const cfg = COLOR_BY_KEY[key];
          if (key === currentInkColorKey) {
            btn.style.backgroundColor = cfg.hex;
            btn.textContent = "";
          } else {
            btn.style.backgroundColor = "#ffffff";
            btn.textContent = "";
          }
        });
        if (practiceFeedback) practiceFeedback.style.display = "flex";
      }

      function handlePracticeAnswer() {
        showPracticeFeedback();
      }

      function proceedAfterPracticeFeedback() {
        if (practiceFeedback) practiceFeedback.style.display = "none";
        if (currentMode === MODE_PRACTICE1) {
          practiceType1Index += 1;
        } else if (currentMode === MODE_PRACTICE2) {
          practiceType2Index += 1;
        }
        setButtonsForColorCircles();
        setupNextPracticeTrial();
      }

      /* --- å€’æ•¸ (ä¿æŒä¸è®Š) --- */

      function startCountdown(callback) {
        if (!countdownScreen || !countdownNumber) {
          callback();
          return;
        }
        let n = 3;
        countdownNumber.textContent = n;
        countdownScreen.style.display = "flex";
        const timerId = setInterval(() => {
          n--;
          if (n <= 0) {
            clearInterval(timerId);
            countdownScreen.style.display = "none";
            callback();
          } else {
            countdownNumber.textContent = n;
          }
        }, 1000);
      }

      /* --- æ­£å¼æ¸¬é©—é¡Œç›®ç”¢ç”Ÿ (ä¿æŒä¸è®Š) --- */

      function generateStroopStimulusForTest() {
        // é¿å…é€£çºŒä¸‰é¡Œæ­£ç¢ºé¡è‰²ç›¸åŒ
        let inkColor;
        let attempts = 0;
        while (true) {
          inkColor = pickRandom(COLOR_CONFIG);
          const key = inkColor.key;
          if (
            lastCorrectKeys.length >= 2 &&
            lastCorrectKeys[lastCorrectKeys.length - 1] === key &&
            lastCorrectKeys[lastCorrectKeys.length - 2] === key
          ) {
            attempts++;
            if (attempts > 50) break; // å®‰å…¨ä¿éšª
            continue;
          }
          break;
        }
        currentInkColorKey = inkColor.key;

        const candidates = COLOR_CONFIG.filter(c => c.key !== inkColor.key);
        let wordColor;
        let tries = 0;
        do {
          wordColor = pickRandom(candidates);
          tries++;
        } while (previousTestWordChar && wordColor.char === previousTestWordChar && tries < 20);

        currentWordChar = wordColor.char;
        previousTestWordChar = currentWordChar;

        stroopWordEl.textContent = currentWordChar;
        stroopWordEl.style.color = inkColor.hex;

        // æ›´æ–°æœ€è¿‘å…©é¡Œæ­£ç¢ºé¡è‰²
        lastCorrectKeys.push(inkColor.key);
        if (lastCorrectKeys.length > 2) lastCorrectKeys.shift();
      }

      /* --- é–‹å§‹æ­£å¼æ¸¬é©— (ä¿æŒä¸è®Š) --- */

      function startTest(testMode) {
        currentMode = MODE_TEST;
        currentTestMode = testMode;
        records = [];
        previousTestWordChar = null;
        lastCorrectKeys = [];
        questionIndex = 0;

        if (testMode === TEST_MODE_20) {
          testStartTime = null;
          setButtonsForColorCircles();
          setModeLabel("æ­£å¼æ¸¬é©—ä¸­ï¼ˆ20 é¡Œé¡è‰²ç‰ˆï¼‰");
        } else if (testMode === TEST_MODE_45_COLOR) {
          testStartTime = performance.now();
          setButtonsForColorCircles();
          setModeLabel("æ­£å¼æ¸¬é©—ä¸­ï¼ˆ45 ç§’é¡è‰²ç‰ˆï¼‰");
        } else if (testMode === TEST_MODE_45_TEXT) {
          testStartTime = performance.now();
          setButtonsForTextButtons();
          setModeLabel("æ­£å¼æ¸¬é©—ä¸­ï¼ˆ45 ç§’æ–‡å­—ç‰ˆï¼‰");
        }

        showPage(testPage);
        generateStroopStimulusForTest();
        trialStartTime = performance.now();
      }

      /* --- æ­£å¼æ¸¬é©—ä½œç­” (ä¿æŒä¸è®Š) --- */

      function handleTestAnswer(chosenKey) {
        if (currentMode !== MODE_TEST || !trialStartTime) return;

        const rt = performance.now() - trialStartTime;
        const inkCfg = COLOR_BY_KEY[currentInkColorKey];
        const chosenCfg = COLOR_BY_KEY[chosenKey];
        const isCorrect = chosenKey === currentInkColorKey;

        records.push({
          trialNumber: records.length + 1,
          wordChar: currentWordChar,
          inkColorLabel: inkCfg.label,
          inkColorKey: currentInkColorKey,
          correctAnswer: inkCfg.label,
          correctKey: currentInkColorKey,
          chosenAnswer: chosenCfg.label,
          chosenKey: chosenKey,
          isCorrect,
          reactionTimeMs: Math.round(rt)
        });

        if (currentTestMode === TEST_MODE_20) {
          questionIndex++;
          if (questionIndex >= TEST_20_QUESTION_COUNT) {
            finishTest();
          } else {
            generateStroopStimulusForTest();
            trialStartTime = performance.now();
          }
        } else {
          const elapsed = performance.now() - testStartTime;
          if (elapsed >= TEST_DURATION_MS) {
            finishTest();
          } else {
            generateStroopStimulusForTest();
            trialStartTime = performance.now();
          }
        }
      }

      /* --- çµæŸæ¸¬é©— & é¡¯ç¤ºçµæœ (åŒ…å«å¹´é½¡è¨ˆç®—å’Œåœ“é»é¡¯ç¤º) --- */

      function finishTest() {
        currentMode = MODE_NONE;
        if (countdownScreen) countdownScreen.style.display = "none";
        setModeLabel("");

        const total = records.length;
        const totalCorrect = records.filter(r => r.isCorrect).length;
        const accuracy = total > 0 ? Math.round(totalCorrect / total * 100) : 0;
        const totalRT = records.reduce((s, r) => s + r.reactionTimeMs, 0);
        const avgRT = total > 0 ? Math.round(totalRT / total) : 0;
        
        // ã€å¹´é½¡è¨ˆç®—ã€‘
        const birthdayInput = document.getElementById("birthday").value;
        const ageString = calculateAge(birthdayInput);

        let modeLabelForTitle = "";
        if (currentTestMode === TEST_MODE_20) {
          modeLabelForTitle = "20 é¡Œé¡è‰²ç‰ˆ";
        } else if (currentTestMode === TEST_MODE_45_COLOR) {
          modeLabelForTitle = "45 ç§’é¡è‰²ç‰ˆ";
        } else if (currentTestMode === TEST_MODE_45_TEXT) {
          modeLabelForTitle = "æ–‡å­—ç‰ˆ 45 ç§’";
        }

        if (resultTitleEl) {
          resultTitleEl.textContent = `æ¸¬é©—å®Œæˆï¼ˆ${modeLabelForTitle}ï¼‰`;
        }
        if (detailTitleEl) {
          detailTitleEl.textContent = `è©³ç´°ç­”é¡Œè¨˜éŒ„ï¼ˆ${modeLabelForTitle}ï¼‰`;
        }

        // ã€æ‘˜è¦çµæœä¸­åŠ å…¥å¹´é½¡ã€‘
        if (resultsSummary) {
          resultsSummary.innerHTML = `
            <div class="result-summary-line">ç¸½ä½œç­”é¡Œæ•¸ï¼š<strong>${total}</strong></div>
            <div class="result-summary-line">ç­”å°é¡Œæ•¸ï¼š<strong>${totalCorrect}</strong></div>
            <div class="result-summary-line">æ­£ç¢ºç‡ï¼š<strong>${accuracy}%</strong></div>
            <div class="result-summary-line">å¹³å‡åæ‡‰æ™‚é–“ï¼š<strong>${total ? avgRT + " æ¯«ç§’" : "â€”"}</strong></div>
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.1);margin:6px 0;">
            <div class="result-summary-line">å¹´é½¡ï¼š<strong>${ageString}</strong></div>
          `;
        }

        // è©³ç´°è¡¨æ ¼ï¼šæ­£ç¢ºç­”æ¡ˆé¡¯ç¤ºç‚ºå½©è‰²åœ“é»
        if (resultsTableBody) {
          resultsTableBody.innerHTML = "";
          records.forEach(r => {
            const inkCfg    = COLOR_BY_KEY[r.inkColorKey];   // é¡Œç›®å­—çš„é¡è‰²
            const choiceCfg = COLOR_BY_KEY[r.chosenKey];     // ä½¿ç”¨è€…ä½œç­”çš„é¡è‰²

            // é¡Œç›®ï¼šå­—æœ¬èº«ï¼‹å­—çš„é¡è‰²
            const questionHtml = `
              <span class="choice-symbol"
                    style="color:${inkCfg.hex};"
                    title="${r.wordChar}å­— / ${r.inkColorLabel}">
                ${r.wordChar}
              </span>
            `;

            // ã€æ­£ç¢ºç­”æ¡ˆé¡¯ç¤ºç‚ºå½©è‰²åœ“é»ã€‘
            const correctHtml = `
              <span class="choice-symbol">
                <div style="
                  width: 24px; 
                  height: 24px; 
                  border-radius: 50%; 
                  background-color: ${inkCfg.hex};
                  margin: 0 auto;"
                  title="æ­£ç¢ºç­”æ¡ˆï¼š${r.correctAnswer}">
                </div>
              </span>
            `;

            // æ‚¨çš„é¸æ“‡ (é¡¯ç¤ºæ–‡å­—)
            const choiceHtml = `
              <span class="choice-symbol" style="color:${choiceCfg.hex};">
                ${choiceCfg.char}
              </span>
            `;

            const resultCell = r.isCorrect
              ? '<span class="result-ok-dot"></span>'
              : '<span class="result-bad">âœ˜</span>';

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.trialNumber}</td>
              <td>${questionHtml}</td>
              <td>${correctHtml}</td>
              <td>${choiceHtml}</td>
              <td>${resultCell}</td>
              <td>${r.reactionTimeMs}</td>
            `;
            resultsTableBody.appendChild(tr);
          });
        }

        showPage(page4);
      }

      /* ===== äº‹ä»¶ç¶å®š ===== */

      if (goToInfoBtn) {
        goToInfoBtn.addEventListener("click", () => {
          showPage(page2);
        });
      }

      if (goToPracticeIntroBtn) {
        goToPracticeIntroBtn.addEventListener("click", () => {
          showPage(practiceIntroPage);
        });
      }

      if (startPracticeBtn) {
        startPracticeBtn.addEventListener("click", () => {
          startPracticeSequence();
        });
      }

      if (practiceFeedback) {
        practiceFeedback.addEventListener("click", () => {
          proceedAfterPracticeFeedback();
        });
      }

      // é¸æ“‡æ­£å¼æ¸¬é©—æ¨¡å¼
      if (btnMode20) {
        btnMode20.addEventListener("click", () => {
          startCountdown(() => startTest(TEST_MODE_20));
        });
      }
      if (btnMode45Color) {
        btnMode45Color.addEventListener("click", () => {
          startCountdown(() => startTest(TEST_MODE_45_COLOR));
        });
      }
      if (btnMode45Text) {
        btnMode45Text.addEventListener("click", () => {
          startCountdown(() => startTest(TEST_MODE_45_TEXT));
        });
      }

      // é¡Œç›®æŒ‰éˆ•
      colorButtons.forEach(btn => {
        btn.addEventListener("click", (e) => {
          const key = e.currentTarget.dataset.colorKey;
          if (!key) return;

          if (currentMode === MODE_PRACTICE1 || currentMode === MODE_PRACTICE2) {
            handlePracticeAnswer(key);
          } else if (currentMode === MODE_TEST) {
            handleTestAnswer(key);
          }
        });
      });

      // ã€ğŸ¯ åŒ¯å‡ºçµæœæŒ‰éˆ•çš„äº‹ä»¶è™•ç†ã€‘
      if (exportBtn) {
        exportBtn.addEventListener("click", () => {
          const name = document.getElementById("name").value || "Unknown";
          const birthday = document.getElementById("birthday").value || "N/A";
          
          let testModeLabel = "";
          if (currentTestMode === TEST_MODE_20) {
            testModeLabel = "20_Question_Color";
          } else if (currentTestMode === TEST_MODE_45_COLOR) {
            testModeLabel = "45_Second_Color";
          } else if (currentTestMode === TEST_MODE_45_TEXT) {
            testModeLabel = "45_Second_Text";
          }
          
          const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, ""); // YYYYMMDD
          const fileName = `stroop_result_${name}_${testModeLabel}_${timestamp}.csv`;
          
          const csvContent = recordsToCsv(records, name, birthday, testModeLabel);
          downloadCsv(csvContent, fileName);
        });
      }

      if (restartBtn) {
        restartBtn.addEventListener("click", () => {
          currentMode = MODE_NONE;
          currentTestMode = null;
          records = [];
          testStartTime = null;
          trialStartTime = null;
          previousTestWordChar = null;
          lastCorrectKeys = [];
          questionIndex = 0;
          showPage(page1);
        });
      }

      if (showDetailBtn) {
        showDetailBtn.addEventListener("click", () => {
          showPage(detailPage);
        });
      }

      if (detailBackBtn) {
        detailBackBtn.addEventListener("click", () => {
          showPage(page4);
        });
      }
    });
  </script>
</body>
</html>
